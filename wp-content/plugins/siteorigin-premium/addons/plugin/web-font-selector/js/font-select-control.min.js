jQuery((function(e){var t=window.socss;t.view.properties.controllers.font_select=t.view.propertyController.extend({template:_.template('<div class="font-wrapper"><select class="socss-property-controller-input"></select></div>'),onChange:function(){},render:function(){this.$el.append(e(this.template({}))),this.field=this.$el.find("select"),this.field.webfontselector({modules:this.args.modules,width:"100%"}),this.field.on("font_change",function(e,t,s){this.updateRule(t,s)}.bind(this))},setValue:function(e,t){t=_.extend({silent:!1},t),this.field.webfontselector("update",e),t.silent||this.trigger("set_value",e)},updateRule:function(e,t){var s,i,r,a=e.font?"'"+e.font+"'":"";if(a+=e.category?", "+e.category:"",this.propertiesView.setRuleValue(this.args.property,a),e.webfont){s=this.args.modules[e.module],i=this.propertiesView.findImport(s.base_url);var l=e.font.replace(new RegExp("\\s","g"),"+");i?(-1===(r=this.importRuleToFontsInfo(i)).families.indexOf(l)&&r.families.push(l),"400"!==e.variant&&"regular"!==e.variant&&-1===r.variants.indexOf(e.variant)&&r.variants.push(e.variant),"latin"!==e.subset&&-1===r.subsets.indexOf(e.subset)&&r.subsets.push(e.subset),r.base_url=s.base_url,this.propertiesView.updateImport(s.base_url,this.fontsInfoToImportRule(r))):(r={base_url:s.base_url,families:[l]},"400"!==e.variant&&"regular"!==e.variant&&(r.variants=[e.variant]),"latin"!=e.subset&&(r.subsets=[e.subset]),this.propertiesView.addImport(this.fontsInfoToImportRule(r)))}if(t&&t.webfont){s=this.args.modules[t.module],i=this.propertiesView.findImport(s.base_url),r=this.importRuleToFontsInfo(i);for(var n=[],o=this.propertiesView.parsed.stylesheet.rules,u=0;u<o.length;u++){var p=o[u];if(p.declarations)for(var f=0;f<p.declarations.length;f++){var h=p.declarations[f];if("font-family"===h.property&&h.value){var m=h.value.match(/\'([^\']+)\'/)[1];-1==n.indexOf(m)&&n.push(m.replace(new RegExp("\\s","g"),"+"))}}}for(var d=[],v=0;v<r.families.length;v++){m=r.families[v];-1==n.indexOf(m)&&d.push(m)}for(var b=0;b<d.length;b++)r.families.splice(r.families.indexOf(d[b]),1);r.base_url=s.base_url,r.families.length>0?this.propertiesView.updateImport(s.base_url,this.fontsInfoToImportRule(r)):this.propertiesView.removeImport(s.base_url)}},importRuleToFontsInfo:function(e){for(var t,s={families:[],variants:[],subsets:[]},i=/[\?|\&]([^=]+)\=([^&\s\)\;]+)/g;null!==(t=i.exec(e.import));)if("family"===t[1]){var r=t[2].split(":");s.families=r[0].split("|"),r.length>1&&(s.variants=r[1].split(","))}else"subset"===t[1]&&(s.subsets=t[2].split(","));return s},fontsInfoToImportRule:function(e){var t={type:"import"},s="url("+e.base_url+"?family="+e.families.join("|");return _.isEmpty(e.variants)||null==e.variants[0]||(s+=":"+e.variants.join(",")),_.isEmpty(e.subsets)||null==e.subsets[0]||(s+="&subset="+e.subsets.join(",")),s+=")",t.import=s,t}})}));